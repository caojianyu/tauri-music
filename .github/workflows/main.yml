name: Build Tauri for Ubuntu Touch (ARM64)
on:
  workflow_dispatch:

jobs:
  build-arm64:
    runs-on: ubuntu-22.04
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装 Rust 及目标架构
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu
          components: rust-src

      - name: 安装 Ubuntu Touch 兼容的编译依赖
        run: |
          # 添加 Ubuntu 20.04 源以获取兼容的库
          echo "deb [arch=arm64] http://ports.ubuntu.com/ focal main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          sudo apt update
          
          # 安装核心依赖（适配 Ubuntu Touch 的版本）
          sudo apt install -y --no-install-recommends \
            gcc-aarch64-linux-gnu \
            libgtk-3-dev:arm64=3.24.20-0ubuntu1 \
            libwebkit2gtk-4.0-dev:arm64=2.32.1-1ubuntu2 \
            libglib2.0-dev:arm64=2.64.6-1~ubuntu20.04.4 \
            libsoup2.4-dev:arm64 \
            libjavascriptcoregtk-4.0-dev:arm64 \
            pkg-config-aarch64-linux-gnu \
            libssl-dev:arm64

      - name: 安装 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: 安装前端依赖并构建
        run: |
          npm install
          npm run build

      - name: 编译适配 Ubuntu Touch 的 Tauri 程序
        run: |
          # 关键环境变量（适配 Ubuntu Touch）
          export PKG_CONFIG_ALLOW_CROSS=1
          export PKG_CONFIG_LIBDIR=/usr/lib/aarch64-linux-gnu/pkgconfig
          export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
          # 禁用 Ubuntu Touch 不支持的特性
          export TAURI_FEATURES="gtk3,webkit2gtk-4.0,http-multi-threaded,-system-tray,-clipboard-manager"
          
          # 编译（禁用 bundle，只输出纯二进制）
          cargo build --release --target aarch64-unknown-linux-gnu --no-bundle

      - name: 检查编译产物依赖（验证兼容性）
        run: |
          # 安装交叉编译的依赖检查工具
          sudo apt install -y aarch64-linux-gnu-readelf
          # 检查二进制依赖的库版本
          aarch64-linux-gnu-readelf -d target/aarch64-unknown-linux-gnu/release/[你的Tauri程序名] | grep NEEDED

      - name: 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: tauri-ubuntu-touch-arm64
          path: target/aarch64-unknown-linux-gnu/release/[你的Tauri程序名]
