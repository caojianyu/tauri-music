name: Build Tauri ARM64
on:
  workflow_dispatch:  # 支持手动触发，不用等代码推送

jobs:
  build-arm64:
    runs-on: ubuntu-22.04
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装 Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu

      - name: 安装ARM64编译依赖
        run: |
          sudo apt update
          sudo apt install -y gcc-aarch64-linux-gnu libgtk-3-dev:arm64 libwebkit2gtk-4.0-dev:arm64 libglib2.0-dev:arm64 pkg-config-aarch64-linux-gnu

      - name: 安装Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: 构建前端
        run: |
          npm install
          npm run build  # 如果你的前端用trunk，改成 trunk build

      - name: 编译ARM64版Tauri
        run: |
          export PKG_CONFIG_ALLOW_CROSS=1
          export PKG_CONFIG_LIBDIR=/usr/lib/aarch64-linux-gnu/pkgconfig
          export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
          cargo build --release --target aarch64-unknown-linux-gnu --no-bundle

      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: tauri-arm64-app
          path: target/aarch64-unknown-linux-gnu/release/  # 上传整个release目录，不用改应用名
